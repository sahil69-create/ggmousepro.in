<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - GG Mouse Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="logo">GG Mouse Pro<span>.</span></a>
                <div class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="store.html">Store</a></li>
                    <li><a href="cart.html" class="cart-link"><i class="fas fa-shopping-cart"></i> <span class="cart-count">0</span></a></li>
                    <li class="auth-item"><a href="login.html" class="btn-sm">Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero" style="min-height: 90vh; padding-top: 120px;">
        <canvas id="bg-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; opacity: 0.25;"></canvas>
        <div class="container" style="position: relative; z-index: 2;">
            <h1 class="text-gradient" style="margin-bottom: 30px;">Checkout</h1>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                <form id="checkout-form" style="background: var(--bg-card); padding: 20px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="color: var(--text-secondary);">Full Name</label>
                            <input id="fullName" type="text" required style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--accent-blue); color: #fff; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: var(--text-secondary);">Email Address</label>
                            <input id="email" type="email" required style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--accent-blue); color: #fff; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: var(--text-secondary);">Phone Number</label>
                            <input id="phone" type="tel" required style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--accent-blue); color: #fff; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: var(--text-secondary);">City</label>
                            <input id="city" type="text" required style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--accent-blue); color: #fff; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: var(--text-secondary);">State</label>
                            <input id="state" type="text" required style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--accent-blue); color: #fff; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: var(--text-secondary);">Pincode</label>
                            <input id="pincode" type="text" required style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--accent-blue); color: #fff; border-radius: 4px;">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="color: var(--text-secondary);">Complete Delivery Address</label>
                        <textarea id="address" required style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--accent-blue); color: #fff; border-radius: 4px; min-height: 100px;"></textarea>
                    </div>
                    <button id="place-order" type="submit" class="btn btn-primary" style="margin-top: 20px;">Place Order</button>
                </form>

                <div id="order-summary" style="background: var(--bg-card); padding: 20px; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px;">Order Summary</h3>
                    <div id="summary-items" style="display: flex; flex-direction: column; gap: 10px;"></div>
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>Total</span>
                        <span id="summary-total">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="text-center">
                <p>&copy; 2024 GG Mouse Pro. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDd32y-HDm5tBlXb-9FJhkEt9RlpEGXW4I",
            authDomain: "ggmp-in-users.firebaseapp.com",
            projectId: "ggmp-in-users",
            storageBucket: "ggmp-in-users.firebasestorage.app",
            messagingSenderId: "1020421910146",
            appId: "1:1020421910146:web:bc9e32626120591f9a8e9b",
            measurementId: "G-P3NBD08WNH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function getCart() {
            return JSON.parse(localStorage.getItem('cart')) || [];
        }

        function renderSummary() {
            const itemsEl = document.getElementById('summary-items');
            const totalEl = document.getElementById('summary-total');
            const cart = getCart();
            itemsEl.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.innerHTML = `<span>${item.name} Ã— ${item.quantity}</span><span>$${(item.price * item.quantity).toFixed(2)}</span>`;
                itemsEl.appendChild(row);
                total += item.price * item.quantity;
            });
            totalEl.textContent = `$${total.toFixed(2)}`;
            return { cart, total };
        }

        function validateEmail(v) {
            return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v);
        }

        function validatePhone(v) {
            return /^\d{10,}$/.test(v);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const { cart } = renderSummary();
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user) {
                const nameEl = document.getElementById('fullName');
                const emailEl = document.getElementById('email');
                if (user.name) nameEl.value = user.name;
                if (user.email) emailEl.value = user.email;
            }
            if (cart.length === 0) {
                window.location.href = 'store.html';
            }
        });

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            const pincode = document.getElementById('pincode').value.trim();
            const address = document.getElementById('address').value.trim();
            const { cart, total } = renderSummary();

            if (!fullName || !email || !phone || !city || !state || !pincode || !address) {
                alert('Please fill all the fields.');
                return;
            }
            if (!validateEmail(email)) {
                alert('Please enter a valid email.');
                return;
            }
            if (!validatePhone(phone)) {
                alert('Please enter a valid phone number.');
                return;
            }

            const order = {
                fullName,
                email,
                phone,
                address,
                city,
                state,
                pincode,
                items: cart.map(i => ({ id: i.id, name: i.name, price: i.price, quantity: i.quantity })),
                total,
                status: 'Pending',
                createdAt: serverTimestamp()
            };

            try {
                const docRef = await addDoc(collection(db, 'orders'), order);
                localStorage.removeItem('cart');
                window.location.href = `order-confirmation.html?orderId=${docRef.id}`;
            } catch (err) {
                alert('Failed to place order. Please try again.');
            }
        });
    </script>
</body>
</html>
